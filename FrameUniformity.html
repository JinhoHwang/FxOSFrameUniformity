<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<!--  
    This is a tool draws graphs related with frame uniformity, touch events and layer movement, 
    Please see the below link page for more details 
       https://bugzilla.mozilla.org/show_bug.cgi?id=990832
    
    How to use this
      Step1 : apply patches attached on https://bugzilla.mozilla.org/show_bug.cgi?id=990832
      Step2 : build your gecko and download it to your device
      Step3 : add a preference to user preference file 
              ex) echo "pref('layers.uniformity-info',true);"  >> /system/b2g/defaults/pref/user.js 
      Step4 : do some dragging or scrolling on device and collect frame uniformity log data
              ex) adb log cat | grep UniformityInfo
      step5 : open this html file in your browser and put the log data into the textarea
              and click the "Reload data" button.
    
 -->
<title>Frame Uniformity</title>
<style>
p {
	font-size: 60%;
}
</style>

<script type='text/javascript'
	src='http://code.jquery.com/jquery-1.8.3.js'></script>
<script type='text/javascript'
	src="http://www.flotcharts.org/javascript/jquery.flot.min.js"></script>
<script type='text/javascript'
	src="http://www.benjaminbuffet.com/public/js/jquery.flot.orderBars.js"></script>
<script type='text/javascript'
	src="http://www.codeskulptor.org/js/jquery.flot.axislabels.min.js"></script>

<script type="text/javascript">
	var valScrollGraphX = new Array();
	var valScrollGraphY = new Array();
	var valTouchMoveX = new Array();
	var valTouchMoveY = new Array();
	var valTimeStamps = new Array();
	var valTouch = new Array();
	var actualLines = 0;
	var layerID;
	var timeDelay;

	function initGlobal() {
		valScrollGraphX.length = 0;
		valScrollGraphY.length = 0;
		valTouchMoveX.length = 0;
		valTouchMoveY.length = 0;
		valTimeStamps.length = 0;
		valTouch.length = 0;
		actualLines = 0;
		timeDelay = 0;
		$("#placeholder1_choices").empty();
		$("#placeholder2_choices").empty();
	}

	function loadData() {
		initGlobal();
		renderData = new Array();
		currentFrame = 0;
		minX = undefined;
		minY = undefined;
		maxX = undefined;
		maxY = undefined;

		var charPos = 0;
		var lastLineLength = 0;
		var lines = document.getElementById('trace').value.split(/\r|\n/);

		actualLines = 0;
		var preDataX, preDataY, preTimeStamp;
		var preTouchX, preTouchY;
		var touchEvent = 0;
		var touchmovecnt = 0;
		var touchDownTime = 0;
		var isNotFirst = false;
		
		for ( var i = 0; i < lines.length; i++) {

			// skip lines without UniformityInfo
			if (!/UniformityInfo/.test(lines[i])) {
				continue;
			}
			var tokens = lines[i].split(/\s+/);
			
			// Parsing Touch Event Data 
			if (/Touch_Event/.test(lines[i])) {
				var k = 0;
				if (/Touch_Event_Down/.test(lines[i])) {
					while (k < tokens.length
							&& tokens[k++] != "Touch_Event_Down");
					touchDownTime = parseInt(tokens[k]);
					valTouch[touchEvent++] = new Array(0, 20);
				} else if (/Touch_Event_Move/.test(lines[i])) {
					while (k < tokens.length
							&& tokens[k++] != "Touch_Event_Move");
					if (touchmovecnt != 0) {
						tmpTouchmovecnt = touchmovecnt - 1;
						valTouchMoveX[tmpTouchmovecnt] = new Array(
								tmpTouchmovecnt, Math
										.abs(parseFloat(tokens[k + 1])
												- preTouchX));
						valTouchMoveY[tmpTouchmovecnt] = new Array(
								tmpTouchmovecnt, Math
										.abs(parseFloat(tokens[k + 2])
												- preTouchY));
					}
					preTouchX = parseFloat(tokens[k + 1]);
					preTouchY = parseFloat(tokens[k + 2]);
					touchmovecnt++;

				} else {
					while (k < tokens.length && tokens[k++] != "Touch_Event_Up");
					var positionTouchEnd = parseInt((parseInt(tokens[k]) - touchDownTime) / 16000000);
					valTouch[touchEvent++] = new Array(positionTouchEnd, 20);
				}
				continue;
			}

			var j = 0;
			
			// skip tokens until ScrollGraph found
			// Parsing Layer Data
			while (j < tokens.length && tokens[j++] != "UniformityInfo");
			if (j >= tokens.length - 3) {
				log("Error parsing line: " + lines[i]);
				continue;
			}

			var timestamp = parseInt(tokens[j + 1] / 1000000);			
			var valueX = parseFloat(tokens[j + 3]);
			var valueY = parseFloat(tokens[j + 4]);

			
			function putData(aX,aY,aTime)
			{
				putScrollData(aX,aY);
				putTimeStampData(aTime);
				actualLines++;
			}
			
			function putScrollData(aX,aY)
			{
				valScrollGraphX[actualLines] = new Array(actualLines, aX);
				valScrollGraphY[actualLines] = new Array(actualLines, aY);				
			}
			
			function putTimeStampData(aNum)
			{
				valTimeStamps[actualLines] = new Array(actualLines, "("
						+ aNum + ")");
			}
			
			function putEmptyData(aNum)
			{
				if (aNum < 1) {
					return;
				}					
				for ( var tick = 0; tick < aNum; tick++) {
					putData(0,0,16);
				}			    
			}
			
			if (isNotFirst) {
				if (!(layerID == tokens[j + 2])) {
					continue;
				}
				var empytNum = (timestamp - preTimeStamp) / 16;
 				putEmptyData(empytNum-1);
 				
 				putData(Math.abs(preDataX - valueX),
 						Math.abs(preDataY - valueY),
 						timestamp - preTimeStamp)
/*  				
				valScrollGraphX[actualLines] = new Array(actualLines, Math
						.abs(preDataX - valueX));
				valScrollGraphY[actualLines] = new Array(actualLines, Math
						.abs(preDataY - valueY));
				valTimeStamps[actualLines] = new Array(actualLines, "("
						+ (timestamp - preTimeStamp) + ")"); */
//				actualLines++;
			} else {
				layerID = tokens[j + 2];
				isNotFirst = true;
				timeDelay = (timestamp - (touchDownTime/1000000)) / 16;
				//alert(timeDelay);
				putEmptyData(timeDelay-1);
			}

			preDataX = valueX;
			preDataY = valueY;
			preTimeStamp = timestamp;
		}

		if (valTouchMoveX.length!=0 && valTouchMoveY.length!=0)
			drawGraph(false);
		if (valScrollGraphX.length!=0 && valScrollGraphX.length!=0) {
			drawGraph(true);
			printInformation(valScrollGraphX, "Scroll_X");
			printInformation(valScrollGraphY, "Scroll_Y");
		}
			
		
	} // End of loadData()

	function printInformation(sourceArray, title) {
		var data = sourceArray;
		var deviation = new Array();
		var sumX = 0;
		var sumY = 0;
		var devnsum = 0;
		var stddevn = 0;
		var len = data.length;

		for ( var i = timeDelay; i < len; i++) {
			sumX = sumX + (data[i][1]);
		}

		var mean = (sumX / (len - timeDelay)).toFixed(6); // 6 decimal places
		// alert("mean :" + mean);

		for (i = timeDelay; i < len; i++) {
			var tmpCnt = i - timeDelay;
			deviation[tmpCnt] = data[i][1] - mean;
			deviation[tmpCnt] = deviation[tmpCnt] * deviation[tmpCnt];
			devnsum = devnsum + deviation[tmpCnt];
		}

		var numOfActualData = len - (timeDelay + 1);
		stddevn = Math.sqrt(devnsum / numOfActualData).toFixed(4); // 4 decimal places
		result = "<p>" + title + " - The mean is:  " + mean + "<p>" + title
				+ " - The standard deviation is:  " + stddevn;
		document.getElementById(title).innerHTML = result;

	}

	function drawGraph(isTouch) {

		var sourceX, sourceY, target, label;

		if (isTouch) {
			sourceX = valTouchMoveX;
			sourceY = valTouchMoveY;
			target = "#placeholder1";
			label = "TouchMove"
		} else {
			sourceX = valScrollGraphX;
			sourceY = valScrollGraphY;
			target = "#placeholder2";
			label = "Layer :" + layerID;
		}

		var datasets = {
			"X" : {
				label : label + " X",
				data : sourceX,
				bars : {
					show : true,
					barWidth : 0.13,
					order : 1
				}
			},
			"Y" : {
				label : label + " Y",
				data : sourceY,
				bars : {
					show : true,
					barWidth : 0.13,
					order : 1
				}
			},
			"TouchEvent" : {
				label : "Touch Event Down/Up",
				data : valTouch,
				points : {
					show : true
				}
			}
		};

		// set color for each series
		var i = 0;
		$.each(datasets, function(key, val) {
			val.color = i;
			i++;
		});

		// insert checkboxes 
		var choiceContainer = $(target + "_choices");
		$.each(datasets,function(key, val) {
							if (isTouch && key == "TouchEvent") {
								return;
							}
							choiceContainer
									.append("<br/><input type='checkbox' name='" + key +
				"' checked='checked' id='id" + key + "'></input>"
											+ "<label for='id" + key + "'>"
											+ val.label + "</label>");

						});

		choiceContainer.find("input").click(plotAccordingToChoices);

		// Display Axis labels
		var options = {
			yaxis : {
				axisLabel : 'Displacement(px)',
				axisLabelUseCanvas : true,
				axisLabelFontSizePixels : 12,
				show : true,
				tickDecimals : 0,
				min : 0
			},
			xaxis : {
				axisLabel : 'Appearance',
				axisLabelUseCanvas : true,
				axisLabelFontSizePixels : 12,
				show : true,
				tickSize : 1,
				font : {
					size : 9,
					style : "normal",
					color : "black"
				},
				tickDecimals : 0,
				min : 0

			}
		};

		function plotAccordingToChoices() {

			var data = [];

			choiceContainer.find("input:checked").each(function() {
				var key = $(this).attr("name");
				if (key && datasets[key]) {
					data.push(datasets[key]);
				}
			});

			if (data.length > 0) {
				$.plot(target, data, options);
			}
		}

		plotAccordingToChoices();

	}
</script>
</head>
<body>
	<div>
		<textarea id="trace" rows="7" style="width: 700px">
05-07 22:01:42.886: I/Gonk(3785): UniformityInfo Touch_Event_Down 5688851987485 580.000000 789.500000
05-07 22:01:42.886: I/Gonk(3785): UniformityInfo Touch_Event_Move 5688855588889 563.000000 787.500000
05-07 22:01:42.896: I/Gonk(3785): UniformityInfo Touch_Event_Move 5688866148937 557.000000 787.000000
05-07 22:01:42.896: I/Gecko(3785): UniformityInfo Layer_Move 5688867766517 0xab8f5c00 -767.997986, 0.000000
05-07 22:01:42.896: I/Gecko(3785): UniformityInfo Layer_Move 5688868102241 0xab8f8c00 -767.923218, 0.000000
05-07 22:01:42.896: I/Gonk(3785): UniformityInfo Touch_Event_Move 5688869475658 529.500000 784.000000
05-07 22:01:42.906: I/Gonk(3785): UniformityInfo Touch_Event_Move 5688877075230 488.500000 779.000000
05-07 22:01:42.916: I/Gonk(3785): UniformityInfo Touch_Event_Move 5688887085912 444.000000 773.000000
05-07 22:01:42.926: I/Gonk(3785): UniformityInfo Touch_Event_Move 5688897310237 398.500000 765.000000
05-07 22:01:42.936: I/Gonk(3785): UniformityInfo Touch_Event_Move 5688907748204 351.000000 756.000000
05-07 22:01:42.946: I/Gonk(3785): UniformityInfo Touch_Event_Move 5688917667325 302.500000 745.500000
05-07 22:01:42.956: I/Gonk(3785): UniformityInfo Touch_Event_Move 5688927983211 250.500000 733.500000
05-07 22:01:42.966: I/Gonk(3785): UniformityInfo Touch_Event_Move 5688938146496 196.500000 721.500000
05-07 22:01:42.976: I/Gonk(3785): UniformityInfo Touch_Event_Move 5688948279259 190.000000 720.000000
05-07 22:01:42.986: I/Gecko(3785): UniformityInfo Layer_Move 5688956519760 0xab8f5c00 -691.997986, 0.000000
05-07 22:01:42.986: I/Gecko(3785): UniformityInfo Layer_Move 5688956672362 0xab8f8c00 -767.923218, 0.000000
05-07 22:01:42.986: I/Gonk(3785): UniformityInfo Touch_Event_Up 5688959846480 190.000000 720.000000
05-07 22:01:43.016: I/Gecko(3785): UniformityInfo Layer_Move 5688981668546 0xab8f5c00 -311.997986, 0.000000
05-07 22:01:43.016: I/Gecko(3785): UniformityInfo Layer_Move 5688982095831 0xab8f8c00 -767.923218, 0.000000
05-07 22:01:43.036: I/Gecko(3785): UniformityInfo Layer_Move 5689000652218 0xab8f5c00 -271.734436, 0.000000
05-07 22:01:43.036: I/Gecko(3785): UniformityInfo Layer_Move 5689001018462 0xab8f8c00 -767.923218, 0.000000
05-07 22:01:43.046: I/Gecko(3785): UniformityInfo Layer_Move 5689016828015 0xab8f5c00 -196.359070, 0.000000
05-07 22:01:43.046: I/Gecko(3785): UniformityInfo Layer_Move 5689017163739 0xab8f8c00 -767.923218, 0.000000
05-07 22:01:43.067: I/Gecko(3785): UniformityInfo Layer_Move 5689034438270 0xab8f5c00 -125.480255, 0.000000
05-07 22:01:43.067: I/Gecko(3785): UniformityInfo Layer_Move 5689034743474 0xab8f8c00 -767.923218, 0.000000
05-07 22:01:43.087: I/Gecko(3785): UniformityInfo Layer_Move 5689051193954 0xab8f5c00 -75.088379, 0.000000
05-07 22:01:43.087: I/Gecko(3785): UniformityInfo Layer_Move 5689052140086 0xab8f8c00 -767.923218, 0.000000
05-07 22:01:43.097: I/Gecko(3785): UniformityInfo Layer_Move 5689068682128 0xab8f5c00 -41.579987, 0.000000
05-07 22:01:43.097: I/Gecko(3785): UniformityInfo Layer_Move 5689069262015 0xab8f8c00 -767.923218, 0.000000
05-07 22:01:43.117: I/Gecko(3785): UniformityInfo Layer_Move 5689085590414 0xab8f5c00 -20.033142, 0.000000
05-07 22:01:43.117: I/Gecko(3785): UniformityInfo Layer_Move 5689086475504 0xab8f8c00 -767.923218, 0.000000
05-07 22:01:43.137: I/Gecko(3785): UniformityInfo Layer_Move 5689101888292 0xab8f5c00 -7.299133, 0.000000
05-07 22:01:43.137: I/Gecko(3785): UniformityInfo Layer_Move 5689102285057 0xab8f8c00 -767.923218, 0.000000
05-07 22:01:43.157: I/Gecko(3785): UniformityInfo Layer_Move 5689126579275 0xab8f5c00 -1.156616, 0.000000
05-07 22:01:43.157: I/Gecko(3785): UniformityInfo Layer_Move 5689127037081 0xab8f8c00 -767.923218, 0.000000
05-07 22:01:43.187: I/Gecko(3785): UniformityInfo Layer_Move 5689150873491 0xab8f8c00 -767.923218, 0.000000
05-07 22:01:43.197: I/Gecko(3785): UniformityInfo Layer_Move 5689167629175 0xab8f8c00 -767.923218, 0.000000
05-07 22:01:43.217: I/Gecko(3785): UniformityInfo Layer_Move 5689183804973 0xab8f8c00 -767.923218, 0.000000
05-07 22:01:43.247: I/Gecko(3785): UniformityInfo Layer_Move 5689202727603 0xab8f8c00 -767.923218, 0.000000
05-07 22:01:43.267: I/Gecko(3785): UniformityInfo Layer_Move 5689231813518 0xab8f8c00 -767.923218, 0.000000
05-07 22:01:43.277: I/Gecko(3785): UniformityInfo Layer_Move 5689248263999 0xab8f8c00 -767.997986, 0.000000
05-07 22:01:43.297: I/Gecko(3785): UniformityInfo Layer_Move 5689265019683 0xab8f8c00 -767.997986, 0.000000
05-07 22:01:43.317: I/Gecko(3785): UniformityInfo Layer_Move 5689281683806 0xab8f8c00 -767.997986, 0.000000
05-07 22:01:43.327: I/Gecko(3785): UniformityInfo Layer_Move 5689298286889 0xab8f8c00 -767.997986, 0.000000
05-07 22:01:43.347: I/Gecko(3785): UniformityInfo Layer_Move 5689315897143 0xab8f8c00 -767.997986, 0.000000
05-07 22:01:43.367: I/Gecko(3785): UniformityInfo Layer_Move 5689331706697 0xab8f8c00 -767.997986, 0.000000
05-07 22:01:43.377: I/Gecko(3785): UniformityInfo Layer_Move 5689349316952 0xab8f8c00 -767.997986, 0.000000
05-07 22:01:43.397: I/Gecko(3785): UniformityInfo Layer_Move 5689365095984 0xab8f8c00 -767.997986, 0.000000
05-07 22:01:43.437: I/Gecko(3785): UniformityInfo Layer_Move 5689409075840 0xab8f8c00 -767.997986, 0.000000
05-07 22:01:43.517: I/Gecko(3785): UniformityInfo Layer_Move 5689481378603 0xab8f8c00 -767.997986, 0.000000
05-07 22:01:43.587: I/Gecko(3785): UniformityInfo Layer_Move 5689559815960 0xab8f8c00 -767.997986, 0.000000
05-07 22:01:43.657: I/Gecko(3785): UniformityInfo Layer_Move 5689622077519 0xab8f8c00 -767.997986, 0.000000
05-07 22:01:43.667: I/Gecko(3785): UniformityInfo Layer_Move 5689638497479 0xab8f8c00 -767.997986, 0.000000
05-07 22:01:43.717: I/Gecko(3785): UniformityInfo Layer_Move 5689687940482 0xab8f8c00 -767.997986, 0.000000
05-07 22:01:43.797: I/Gecko(3785): UniformityInfo Layer_Move 5689761403020 0xab8f8c00 -767.997986, 0.000000
05-07 22:01:43.817: I/Gecko(3785): UniformityInfo Layer_Move 5689782431556 0xab8f8c00 -767.997986, 0.000000
05-07 22:01:43.857: I/Gecko(3785): UniformityInfo Layer_Move 5689822413243 0xab8f8c00 -767.997986, 0.000000
05-07 22:01:43.947: I/Gecko(3785): UniformityInfo Layer_Move 5689910983364 0xab8f8c00 -767.997986, 0.000000
05-07 22:01:43.987: I/Gecko(3785): UniformityInfo Layer_Move 5689956641841 0xab8f8c00 -767.997986, 0.000000
05-07 22:01:44.138: I/Gecko(3785): UniformityInfo Layer_Move 5690102101936 0xab8f8c00 -767.997986, 0.000000
05-07 22:01:44.208: I/Gecko(3785): UniformityInfo Layer_Move 5690173977412 0xab8f8c00 -767.997986, 0.000000
05-07 22:01:44.268: I/Gecko(3785): UniformityInfo Layer_Move 5690238772163 0xab8f8c00 -767.997986, 0.000000
05-07 22:01:44.358: I/Gecko(3785): UniformityInfo Layer_Move 5690326640314 0xab8f8c00 -767.997986, 0.000000
05-07 22:01:44.428: I/Gecko(3785): UniformityInfo Layer_Move 5690391465585 0xab8f8c00 -767.997986, 0.000000
05-07 22:01:44.488: I/Gecko(3785): UniformityInfo Layer_Move 5690456748662 0xab8f8c00 -767.997986, 0.000000
05-07 22:01:44.558: I/Gecko(3785): UniformityInfo Layer_Move 5690522062259 0xab8f8c00 -767.997986, 0.000000
05-07 22:01:44.748: I/Gecko(3785): UniformityInfo Layer_Move 5690711990536 0xab8f8c00 -767.997986, 0.000000
05-07 22:01:44.928: I/Gecko(3785): UniformityInfo Layer_Move 5690899294062 0xab8f8c00 -767.997986, 0.000000
05-07 22:01:44.984: I/Gecko(3785): UniformityInfo Layer_Move 5690945453282 0xab8f8c00 -767.997986, 0.000000
05-07 22:01:45.144: I/Gecko(3785): UniformityInfo Layer_Move 5691102818948 0xab8f8c00 -767.997986, 0.000000
05-07 22:01:45.374: I/Gecko(3785): UniformityInfo Layer_Move 5691331254233 0xab8f8c00 -767.997986, 0.000000
05-07 22:01:45.504: I/Gecko(3785): UniformityInfo Layer_Move 5691466408787 0xab8f8c00 -767.997986, 0.000000
05-07 22:01:45.554: I/Gecko(3785): UniformityInfo Layer_Move 5691512101398 0xab8f8c00 -767.997986, 0.000000
05-07 22:01:45.734: I/Gecko(3785): UniformityInfo Layer_Move 5691697085785 0xab8f8c00 -767.997986, 0.000000
05-07 22:01:45.954: I/Gecko(3785): UniformityInfo Layer_Move 5691918584891 0xab8f8c00 -767.997986, 0.000000
05-07 22:01:46.044: I/Gecko(3785): UniformityInfo Layer_Move 5692004872525 0xab8f8c00 -767.997986, 0.000000
05-07 22:01:59.238: I/Gecko(3785): UniformityInfo Layer_Move 5705206754774 0xab8f8c00 -767.997986, 0.000000
05-07 22:01:59.539: I/Gecko(3785): UniformityInfo Layer_Move 5705503534875 0xab8f8c00 -767.997986, 0.000000
05-07 22:01:59.559: I/Gecko(3785): UniformityInfo Layer_Move 5705528408978 0xab8f8c00 -767.997986, 0.000000
05-07 22:01:59.749: I/Gecko(3785): UniformityInfo Layer_Move 5705711378612 0xab8f8c00 -767.997986, 0.000000
05-07 22:01:59.969: I/Gecko(3785): UniformityInfo Layer_Move 5705931094773 0xab8f8c00 -767.997986, 0.000000
05-07 22:02:00.019: I/Gecko(3785): UniformityInfo Layer_Move 5705983284609 0xab8f8c00 -767.997986, 0.000000
05-07 22:02:01.020: I/Gecko(3785): UniformityInfo Layer_Move 5706985085310 0xab8f8c00 -767.997986, 0.000000
05-07 22:02:04.254: I/Gecko(3785): UniformityInfo Layer_Move 5710213225093 0xab8f8c00 -767.997986, 0.000000
05-07 22:02:09.249: I/Gecko(3785): UniformityInfo Layer_Move 5715210417217 0xab8f8c00 -767.997986, 0.000000
05-07 22:03:01.044: I/Gecko(3785): UniformityInfo Layer_Move 5767001535783 0xab8f8c00 -767.997986, 0.000000
05-07 22:03:09.273: I/Gecko(3785): UniformityInfo Layer_Move 5775239258962 0xab8f8c00 -767.997986, 0.000000
05-07 22:03:14.258: I/Gecko(3785): UniformityInfo Layer_Move 5780229461922 0xab8f8c00 -767.997986, 0.000000
                </textarea>
		<button onclick="loadData()">Reload data</button>
	</div>
	<div id="Graphs" style="width: 1070px; padding: 10px">
		<div class="Graph1">
			<div id="placeholder1"
				style="float: left; width: 900px; height: 200px;"></div>
			<p id="placeholder1_choices" style="float: right; width: 150px;"></p>
		</div>
		<div class="Graph2">
			<div id="placeholder2"
				style="float: left; width: 900px; height: 200px;"></div>
			<p id="placeholder2_choices" style="float: right; width: 150px;"></p>
		</div>
	</div>
	<div id="numbers" style="width: 1000px">
		<div id="Scroll_X" style="float: left; width: 450px; height: 80px;"></div>
		<div id="Scroll_Y" style="float: right; width: 450px; height: 80px;"></div>
	</div>
</body>
</html>
